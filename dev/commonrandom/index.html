<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Common Random Numbers · CompetingClocks.jl</title><meta name="title" content="Common Random Numbers · CompetingClocks.jl"/><meta property="og:title" content="Common Random Numbers · CompetingClocks.jl"/><meta property="twitter:title" content="Common Random Numbers · CompetingClocks.jl"/><meta name="description" content="Documentation for CompetingClocks.jl."/><meta property="og:description" content="Documentation for CompetingClocks.jl."/><meta property="twitter:description" content="Documentation for CompetingClocks.jl."/><meta property="og:url" content="https://adolgert.github.io/CompetingClocks.jl/commonrandom/"/><meta property="twitter:url" content="https://adolgert.github.io/CompetingClocks.jl/commonrandom/"/><link rel="canonical" href="https://adolgert.github.io/CompetingClocks.jl/commonrandom/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">CompetingClocks.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Guide</span><ul><li><a class="tocitem" href="../guide/">Competing Clocks</a></li><li><a class="tocitem" href="../mainloop/">Sample Main Loop</a></li><li><a class="tocitem" href="../distributions/">Non-exponential Simulation</a></li></ul></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../distrib/">Notation for Distributions</a></li><li><a class="tocitem" href="../background/">Markov Processes</a></li><li><a class="tocitem" href="../gsmp/">GSMP</a></li><li><a class="tocitem" href="../samplers/">Understanding Samplers</a></li><li><a class="tocitem" href="../hierarchical/">Hierarchical Samplers</a></li><li><a class="tocitem" href="../memory/">Transitions with Memory</a></li><li class="is-active"><a class="tocitem" href>Common Random Numbers</a><ul class="internal"><li><a class="tocitem" href="#Introduction"><span>Introduction</span></a></li><li><a class="tocitem" href="#Using-Common-Random-Numbers-in-CompetingClocks"><span>Using Common Random Numbers in CompetingClocks</span></a></li><li><a class="tocitem" href="#Multithreading"><span>Multithreading</span></a></li><li><a class="tocitem" href="#Checking-effectiveness-of-Common-Random-Numbers"><span>Checking effectiveness of Common Random Numbers</span></a></li></ul></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../constant_birth/">Birth-death Process</a></li><li><a class="tocitem" href="../sir/">SIR Model</a></li><li><a class="tocitem" href="../reliability/">Reliability</a></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../interface/">Interface</a></li><li><a class="tocitem" href="../reference/">Samplers</a></li><li><a class="tocitem" href="../algorithms/">Algorithms</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href>Common Random Numbers</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Common Random Numbers</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/adolgert/CompetingClocks.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/adolgert/CompetingClocks.jl/blob/main/docs/src/commonrandom.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Common-Random-Numbers"><a class="docs-heading-anchor" href="#Common-Random-Numbers">Common Random Numbers</a><a id="Common-Random-Numbers-1"></a><a class="docs-heading-anchor-permalink" href="#Common-Random-Numbers" title="Permalink"></a></h1><h2 id="Introduction"><a class="docs-heading-anchor" href="#Introduction">Introduction</a><a id="Introduction-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction" title="Permalink"></a></h2><p>If you set up the same model and run it with different initial random number generator (RNG) states, then it will create a set of trajectories. CompetingClocks sees these as a sequence of clock events and times of those events. You are usually interested in some summary outcomes of a simulation, such as the total time to a goal or the number of events. This summary outcome is a predictable function of the trajectories. We often want to ask how the goal function depends on simulation parameters, and that can be difficult to determine because each trajectory gives an individual value, and the set of trajectories gives an estimate that can have wide variance.</p><p>What we want is a <a href="https://en.wikipedia.org/wiki/Variance_reduction">variance reduction</a> technique. Common random numbers (CRN) are a variance reduction technique that enables you to use fewer simulation runs to compare the effect of different simulation parameters on the outcome. There are several other variance reduction techniques, such as antithetic variates and importance sampling, but let&#39;s look at common random numbers in CompetingClocks.</p><p>If you estimate a value with <span>$n$</span> independent trajectories, then the bias of the estimate is proportional to <span>$1/\sqrt{n}$</span> in most cases. If you want to distinguish the effect of changing a parameter, then the estimate must be precise enough that you can see the difference. It is common to use millions of trajectories. On the other hand, CRN means that you can produce <span>$n=100$</span> trajectories, with significant bias in the estimate, and still see the effect of changing a parameter.</p><p>CRN works well when the sample path is similar from run to run. If two runs use completely different events, then there will be too little overlap. If the causal chain of which events affect other events changes, that can be a problem, too. In most cases, people try CRN and see if it helps.</p><h2 id="Using-Common-Random-Numbers-in-CompetingClocks"><a class="docs-heading-anchor" href="#Using-Common-Random-Numbers-in-CompetingClocks">Using Common Random Numbers in CompetingClocks</a><a id="Using-Common-Random-Numbers-in-CompetingClocks-1"></a><a class="docs-heading-anchor-permalink" href="#Using-Common-Random-Numbers-in-CompetingClocks" title="Permalink"></a></h2><p>CompetingClocks implements common random numbers by recording the state of the random number generator every time a clock is enabled. There are other ways to do this, but this one works with the <a href="../reference/#CompetingClocks.CombinedNextReaction">CombinedNextReaction</a> and <a href="../reference/#CompetingClocks.FirstToFire">FirstToFire</a> samplers. The workflow you would use looks notionally like:</p><ol><li>Create a sampler.</li><li>Wrap it in a <a href="../reference/#CompetingClocks.CommonRandomRecorder">CommonRandomRecorder</a>.</li><li>Run a lot of simulations in order to explore and record all possible clock states. Run <code>reset!(recorder)</code> after each simulation.</li><li>For every parameter set to try, run it the same way, using <code>reset!</code> after each run.</li><li>Compare outcomes.</li></ol><p>Because the <code>CommonRandomRecorder</code> stores the state of the random number generator at each step, it works best with random number generators that have small state, such as Xoshiro on a linear congruential generator (LCG).</p><pre><code class="language-julia hljs">using Random: Xoshiro
using CompetingClocks
example_clock = (3, 7)  # We will use clock IDs that are a tuple of 2 integers.
model = MakeModel()
sampler = FirstToFire{typeof(example_clock),Float64}()
crn_sampler = CommonRandomRecorder(sampler, typeof(example_clock), Xoshiro)
for trial_idx in 1:100
    run_simulation(model, crn_sampler)
    reset!(crn_sampler)
end
for param_idx in 1:10
    each_model = modify_model!(model, param_idx)
    run_simulation(each_model, crn_sampler)
    reset!(crn_sampler)
end</code></pre><h2 id="Multithreading"><a class="docs-heading-anchor" href="#Multithreading">Multithreading</a><a id="Multithreading-1"></a><a class="docs-heading-anchor-permalink" href="#Multithreading" title="Permalink"></a></h2><p>A joy of using simulations is how easy it is to parallelize simulation runs across tasks. That can be a challenge for the <code>CommonRandomRecorder</code> because it continues to observe and record new RNG states as it comes across them. That will result in divergence between behavior on different threads. For that reason, it is possible to <a href="../reference/#CompetingClocks.freeze">freeze</a> a <code>CommonRandomRecorder</code>. It will stop recording states, so make sure to first prime it with lots of simulation runs, and then freeze the recorder and use that as the sampler for multiple simulations on multiple threads.</p><pre><code class="language-julia hljs">using Random: Xoshiro
using CompetingClocks
example_clock = (3, 7)  # We will use clock IDs that are a tuple of 2 integers.
model = MakeModel()
sampler = FirstToFire{typeof(example_clock),Float64}()
crn_sampler = CommonRandomRecorder(sampler, typeof(example_clock), Xoshiro)
for trial_idx in 1:100
    run_simulation(model, crn_sampler)
    reset!(crn_sampler)
end
for thread_idx in 1:10
    frozen_crn = freeze(crn_sampler)
    # start a simulation run on this thread with frozen_crn.
end</code></pre><h2 id="Checking-effectiveness-of-Common-Random-Numbers"><a class="docs-heading-anchor" href="#Checking-effectiveness-of-Common-Random-Numbers">Checking effectiveness of Common Random Numbers</a><a id="Checking-effectiveness-of-Common-Random-Numbers-1"></a><a class="docs-heading-anchor-permalink" href="#Checking-effectiveness-of-Common-Random-Numbers" title="Permalink"></a></h2><p>If your simulation has a large sample space, CRN may not help. We run a first set of simulations in order to record the state of the system for lots of different clocks and different multiplicities of clock events. If that worked well, then subsequent runs of the simulation will re-use draws from the random number generator. If there are a lot of events which are needed but haven&#39;t been recorded, those misses are a sign that CRN is unlikely to reduce variance much for this simulation.</p><p>We check this by checking the <a href="../reference/#CompetingClocks.misscount">misscount</a> during later runs of the simulation under CRN. If that miss count is high, we can look into which clocks are firing that didn&#39;t previously fire by iterating over the <a href="../reference/#CompetingClocks.misses">misses</a>, which are pairs of (clock key, number of misses for that clock).</p><p>The final word on effectiveness of CRN is to look at the variance of summary outcomes for runs with and without CRN. The CRN will, in general, slow down a sampler, but it should mean that many fewer runs are required to distinguish the effect of changes in system parameters.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../memory/">« Transitions with Memory</a><a class="docs-footer-nextpage" href="../constant_birth/">Birth-death Process »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.1 on <span class="colophon-date" title="Sunday 2 June 2024 02:00">Sunday 2 June 2024</span>. Using Julia version 1.10.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
