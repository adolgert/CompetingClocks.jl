<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Notation for Distributions · Fleck.jl</title><meta name="title" content="Notation for Distributions · Fleck.jl"/><meta property="og:title" content="Notation for Distributions · Fleck.jl"/><meta property="twitter:title" content="Notation for Distributions · Fleck.jl"/><meta name="description" content="Documentation for Fleck.jl."/><meta property="og:description" content="Documentation for Fleck.jl."/><meta property="twitter:description" content="Documentation for Fleck.jl."/><meta property="og:url" content="https://adolgert.github.io/Fleck.jl/distrib/"/><meta property="twitter:url" content="https://adolgert.github.io/Fleck.jl/distrib/"/><link rel="canonical" href="https://adolgert.github.io/Fleck.jl/distrib/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Fleck.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Guide</span><ul><li><a class="tocitem" href="../guide/">Bag of Clocks</a></li><li><a class="tocitem" href="../mainloop/">Sample Main Loop</a></li><li><a class="tocitem" href="../distributions/">How Fleck Decides What Happens Next</a></li></ul></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../objects/">Structure</a></li><li><a class="tocitem" href="../commonrandom/">Common Random Numbers</a></li><li><a class="tocitem" href="../background/">Background</a></li><li class="is-active"><a class="tocitem" href>Notation for Distributions</a><ul class="internal"><li><a class="tocitem" href="#Notation"><span>Notation</span></a></li><li><a class="tocitem" href="#Using-Julia&#39;s-Distributions"><span>Using Julia&#39;s Distributions</span></a></li><li><a class="tocitem" href="#Requirements-for-a-Continuous-Time-Simulation"><span>Requirements for a Continuous-Time Simulation</span></a></li><li><a class="tocitem" href="#Acknowledgement"><span>Acknowledgement</span></a></li></ul></li><li><a class="tocitem" href="../develop/">Develop</a></li><li><a class="tocitem" href="../samplers/">Understanding Samplers</a></li><li><a class="tocitem" href="../vas/">Vector Addition Systems</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../constant_birth/">Birth-death Process</a></li><li><a class="tocitem" href="../sir/">SIR Model</a></li><li><a class="tocitem" href="../reliability/">Reliability</a></li></ul></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href>Notation for Distributions</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Notation for Distributions</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/adolgert/Fleck.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/adolgert/Fleck.jl/blob/main/docs/src/distrib.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Notation-for-Distributions"><a class="docs-heading-anchor" href="#Notation-for-Distributions">Notation for Distributions</a><a id="Notation-for-Distributions-1"></a><a class="docs-heading-anchor-permalink" href="#Notation-for-Distributions" title="Permalink"></a></h1><p>This describes implementation of distributions for sampling of distributions for stochastic simulation in continuous time. This kind of simulation makes specific demands on what calls a distribution must support, and those calls are different from what libraries provide. This is a guide for implementation of new distributions and a way to ensure that those implemented look correct. If something is wrong here, it matters, so file a bug report.</p><h2 id="Notation"><a class="docs-heading-anchor" href="#Notation">Notation</a><a id="Notation-1"></a><a class="docs-heading-anchor-permalink" href="#Notation" title="Permalink"></a></h2><p>First, let&#39;s affix notation. The cumulative distribution function of every regular distribution can be written as an integral over its hazard rate, <span>$\lambda$</span></p><p class="math-container">\[F(t)=1-e^{-\int_{0}^t \lambda(s)ds}.\]</p><p>All algorithms for stochastic simulation treat distributions as being defined in absolute time, specified as an enabling time, <span>$t_e$</span>,</p><p class="math-container">\[F(t, t_e)=1-e^{-\int_{0}^{t-t_e} \lambda(s)ds}.\]</p><p>Working with distributions in absolute time is a simple shift of the time scale and will be ignored in further discussions, although the enabling time, <span>$t_e$</span>, will certainly appear in code.</p><p>The density function is the derivative of the cumulative distribution function,</p><p class="math-container">\[f(t)=\frac{dF(t)}{dt}=\lambda(t)e^{-\int_{0}^t \lambda(s)ds}.\]</p><p>The survival is</p><p class="math-container">\[G(t)=1-F(t)=e^{-\int_{0}^t \lambda(s)ds}.\]</p><p>Because survival is multiplicative, we further label the survival from time <span>$t_0$</span> to <span>$t_1$</span> as</p><p class="math-container">\[G(t_0, t_1)=\frac{G(t_1)}{G(t_0)}=e^{-\int_{t_0}^{t_1} \lambda(s)ds}\]</p><h2 id="Using-Julia&#39;s-Distributions"><a class="docs-heading-anchor" href="#Using-Julia&#39;s-Distributions">Using Julia&#39;s Distributions</a><a id="Using-Julia&#39;s-Distributions-1"></a><a class="docs-heading-anchor-permalink" href="#Using-Julia&#39;s-Distributions" title="Permalink"></a></h2><p>Julia&#39;s continuous univariate distributions support a fixed interface. In this section, we look at how to translate any distribution into the operations above.</p><p>In this table, <code>d</code> is the distribution.</p><table><tr><th style="text-align: right">Julia call</th><th style="text-align: right">Notation</th></tr><tr><td style="text-align: right"><code>cdf(d,t)</code></td><td style="text-align: right"><span>$F(t)$</span></td></tr><tr><td style="text-align: right"><code>quantile(d,q)</code></td><td style="text-align: right"><span>$F^{-1}(q)$</span></td></tr><tr><td style="text-align: right"><code>logcdf(d,t)</code></td><td style="text-align: right"><span>$\ln(F(t))$</span></td></tr><tr><td style="text-align: right"><code>ccdf(d,t)</code></td><td style="text-align: right"><span>$G(t)$</span></td></tr><tr><td style="text-align: right"><code>logccdf(d,t)</code></td><td style="text-align: right"><span>$-\int_0^t \lambda(s)ds$</span></td></tr><tr><td style="text-align: right"><code>quantile(d,q)</code></td><td style="text-align: right"><span>$F^{-1}(q)$</span></td></tr><tr><td style="text-align: right"><code>cquantile(d,q)</code></td><td style="text-align: right"><span>$F^{-1}(1-q)=G^{-1}(q)$</span></td></tr><tr><td style="text-align: right"><code>invlogcdf(d,lp)</code></td><td style="text-align: right"><span>$F^{-1}(e^{l_p})$</span></td></tr><tr><td style="text-align: right"><code>invlogccdf(d,lp)</code></td><td style="text-align: right"><span>$G^{-1}(e^{l_p})$</span> or <span>$-\int_0^{t(l_p)}\lambda(s)ds=l_p$</span></td></tr><tr><td style="text-align: right"><code>randexp(rng)</code></td><td style="text-align: right"><span>$-\ln(1-U)$</span></td></tr></table><h2 id="Requirements-for-a-Continuous-Time-Simulation"><a class="docs-heading-anchor" href="#Requirements-for-a-Continuous-Time-Simulation">Requirements for a Continuous-Time Simulation</a><a id="Requirements-for-a-Continuous-Time-Simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Requirements-for-a-Continuous-Time-Simulation" title="Permalink"></a></h2><h3 id="Shifted-Sample"><a class="docs-heading-anchor" href="#Shifted-Sample">Shifted Sample</a><a id="Shifted-Sample-1"></a><a class="docs-heading-anchor-permalink" href="#Shifted-Sample" title="Permalink"></a></h3><p>The First Reaction method requires that we sample a distribution given that we known it has not yet fired by a time <span>$t_0$</span>. The statement that it hasn&#39;t fired by time <span>$t_0$</span> creates a new distribution from which to sample. If the old distribution had the hazard <span>$G(t)=G(0, t)$</span>, it could be written as</p><p class="math-container">\[G(0, t)=G(0, t_0)G(t_0, t).\]</p><p>It is this partial survival, since <span>$t_0$</span>, that we want to sample. Solving for <span>$G(t_0, t)$</span> and subtracting both sides from 1,</p><p class="math-container">\[1-G(t_0, t)=\frac{G(0, t_0)-G(0, t)}{G(0, t_0)}.\]</p><p>Written in terms of the cumulative distribution functions, the cdf of the new distribution, which we&#39;ll call <span>$F(t, t_0)$</span>, is</p><p class="math-container">\[F(t, t_0)=\frac{F(t)-F(t_0)}{1-F(t_0)}\]</p><p>This kind of distribution could be sampled by a rejection method, but the default way to sample it is by inversion, which means generating a uniform random value between <span>$[0,1]$</span> and solving <span>$U=F(t)$</span> for <span>$t$</span>. For Eq.   <code>gibson-shifted</code>{.interpreted-text role=&quot;eq&quot;}, this becomes</p><p class="math-container">\[\begin{aligned}
 U&amp;=F(t,t_0,t_e) \\
  &amp;=\frac{F(t,t_e)-F(t_0,t_e)}{1-F(t_0,t_e)} \\
U(1-F(t_0,t_e))&amp;=F(t,t_e)-F(t_0,t_e) \\
F(t,t_e)&amp;=U(1-F(t_0,t_e))+F(t_0,t_e) \\
F(t-t_e)&amp;=U(1-F(t_0-t_e))+F(t_0-t_e) \\
t-t_e &amp;= F^{-1}\left[U(1-F(t_0-t_e))+F(t_0-t_e)\right] \\
t &amp;= t_e+F^{-1}\left[U(1-F(t_0-t_e))+F(t_0-t_e)\right]
\end{aligned}\]</p><p>We will call this operation <strong>SampleShifted.</strong></p><h3 id="Hazard-Rate-for-Next-Reaction"><a class="docs-heading-anchor" href="#Hazard-Rate-for-Next-Reaction">Hazard Rate for Next Reaction</a><a id="Hazard-Rate-for-Next-Reaction-1"></a><a class="docs-heading-anchor-permalink" href="#Hazard-Rate-for-Next-Reaction" title="Permalink"></a></h3><p>The Next Reaction method requires sampling a distribution such that the quantile is saved, so that later adjustments to the distribution can use the same quantile.</p><p>During a simulation, the hazard rate, <span>$\lambda$</span>, is a function of the state of the system, <span>$X(t)$</span>. The state of the system only changes in jumps, so the hazard rate is effectively a series of distributions in time. For instance, a hazard rate, from enabling time <span>$T_0$</span> to firing time <span>$T_3$</span>, might have three parts.</p><p class="math-container">\[\begin{aligned}
  \lambda(\{X_0, T_0\}, t)=h_0(t) &amp; \qquad T_0 \le t &lt; T_1 \\
  \lambda(\{X_0, T_0, X_1, T_1\}, t)=h_1(t) &amp; \qquad T_1 \le t &lt; T_2 \\
  \lambda(\{X_0, T_0, X_1, T_1, X_2, T_2\}, t)=h_2(t) &amp; \qquad T_2 \le t &lt; T_3
\end{aligned}\]</p><p>The algorithm therefore samples for a firing time from <span>$h_0(t)$</span> as soon as the transition is enabled, but that time will turn out to be wrong (we call it a putative time). Later, the algorithm will resample using <span>$h_1(t)$</span> using the original sample&#39;s quantile and taking time off the clock. If the first sample were by inversion, it would look like solving this equation for <span>$t$</span> (still ignoring enabling times),</p><p class="math-container">\[U=1-\exp\left(\int_0^{t}h_0(s)ds\right).\]</p><p>Then a later sample would use the same <span>$U$</span>, but with knowledge that the distribution now contains a new part, <span>$h_1(t)$</span>,</p><p class="math-container">\[\begin{equation}\tag{cdf-consume}
U=1-\exp\left(-\int_0^{t_1}h_0(s)ds\right)\exp\left(-\int_{t_1}^{t}h_1(s)ds\right)
\end{equation}\]</p><p>Anderson had the bright idea to write the quantile as an exponential quantile, <span>$1-U=e^{\ln (1-U)}$</span>, so that the equation requires only addition of integrated hazards,</p><p class="math-container">\[\begin{aligned}
  \ln(1-U)&amp;=-\int_0^{t_1}h_0(s)ds-\int_{t_1}^{t}h_1(s)ds \\
  \int_{t_1}^{t}h_1(s)ds&amp;=-\ln(1-U)-\int_0^{t_1}h_0(s)ds.
\end{aligned}\]</p><p>As the underlying distribution, <span>$h_i(t)$</span>, changes, the right hand side gets smaller and smaller. Let&#39;s call the sum of all consumed hazard <span>$\gamma$</span>,</p><p class="math-container">\[\gamma=\sum_i \int_{t_i}^{t_{i+1}}h_i(s)ds\]</p><p>The algorithm therefore needs three operations from the distribution.</p><ol><li><p><strong>MeasuredSample</strong>---Sample the distribution, returning the  exponential quantile. Calling the random number generator, <code>rng</code>  and the putative time <span>$t_p$</span>, it&#39;s</p><p><span>$\left(rng, h_0(t)\right) \mapsto \left(t_p, -\ln(1-U)\right).$</span></p></li><li><p><strong>ConsumeSample</strong>---Consume remaining quantile for the next  sample. If the sum of hazard in the past is called <span>$\gamma$</span>, then</p><p><span>$\left(\gamma, h_i(t), t_i\right) \mapsto \left(\gamma&#39;, t_{i+1}\right)$</span></p></li><li><p><strong>Putative</strong>---Generate a new putative time from the exponential  quantile and the consumed hazard,</p><p><span>$\left(-\ln(1-U), \gamma, t_i, h_i(t)\right) \mapsto p_t$</span></p></li></ol><p>The nice part about the first step is that there is no need to sample by inversion. Any sampling method will do, as long as the exponential quantile is calculated.</p><h3 id="Cumulative-Distributions-for-Next-Reaction"><a class="docs-heading-anchor" href="#Cumulative-Distributions-for-Next-Reaction">Cumulative Distributions for Next Reaction</a><a id="Cumulative-Distributions-for-Next-Reaction-1"></a><a class="docs-heading-anchor-permalink" href="#Cumulative-Distributions-for-Next-Reaction" title="Permalink"></a></h3><p>The original form of the Next Reaction, by Gibson and Bruck, was written in terms, not of the hazards, but of the cumulative distribution functions. This form remains useful because some distributions are much simpler, or more accurate, to sample as cdfs instead of sampling from their hazard rates.</p><p>Returning to Eq. cdf-consume above, this can be rewritten as</p><p class="math-container">\[1-U=\exp\left(-\int_0^{t_1}h_0(s)ds\right)\exp\left(-\int_{t_1}^{t}h_1(s)ds\right)\]</p><p>In terms of the survival functions, this becomes</p><p class="math-container">\[1-U=G_0(0, t_1)G_1(t_1, t)\]</p><p>If we wish to solve this for <span>$t$</span>, then, in terms of the survival, it looks like</p><p class="math-container">\[G_1(t_1, t)=\frac{1-U}{G_0(0, t_1)}\]</p><p>Writing the left-hand side as a cumulative distribution function requires the transformation</p><p class="math-container">\[G(a, b)=\frac{G(b)}{G(a)}=\frac{1-F(b)}{G(a)}\]</p><p>so we have</p><p class="math-container">\[F_1(t)=1-G_1(t_1) \frac{1-U}{G_0(0, t_1)}\]</p><p>This generalizes to many steps as</p><p class="math-container">\[F_j(t)=1-G_j(t_j) (1-U) \prod_i^j \frac{G_i(t_i)}{G_i(t_{i+1})}\]</p><p>Let&#39;s call the running product on the right <span>$\delta$</span>,</p><p class="math-container">\[\delta=\prod_i^j \frac{G_i(t_i)}{G_i(t_{i+1})}\]</p><p>Then the algorithm requires three operations</p><ol><li><p><strong>MeasuredSample</strong>---Sample the distribution, returning the  quantile. Calling the random number generator, &quot;rng,&quot; and the  putative time <span>$t_p$</span>, it&#39;s</p><p><span>$\left(\rng, h_0(t)\right) \mapsto \left(t_p, 1-U\right).$</span></p></li><li><p><strong>ConsumeSample</strong>---Consume remaining quantile for the next  sample.</p><p><span>$\left(\delta_i, h_i(t), t_i\right) \mapsto \left(\delta_{i+1}, t_{i+1}\right)$</span></p></li><li><p><strong>Putative</strong>---Generate a new putative time from the exponential  quantile and the consumed hazard,</p><p><span>$\left(1-U, \delta_i, t_i, h_i(t)\right) \mapsto p_t$</span></p></li></ol><p>As you can see by comparison with the hazards version, it&#39;s simple to write the algorithm to accommodate either method of sampling. Therefore, each distribution can choose which interface to support.</p><h2 id="Acknowledgement"><a class="docs-heading-anchor" href="#Acknowledgement">Acknowledgement</a><a id="Acknowledgement-1"></a><a class="docs-heading-anchor-permalink" href="#Acknowledgement" title="Permalink"></a></h2><p>This section comes was created by the Analytical Framework for Infectious Disease Dynamics (AFIDD) group at Cornell University in conjunction with the USDA Agricultural Research Service. This work was supported by the Science &amp; Technology Directorate, Department of Homeland Security via interagency agreement no. HSHQDC-10-X-00138.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../background/">« Background</a><a class="docs-footer-nextpage" href="../develop/">Develop »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.1 on <span class="colophon-date" title="Wednesday 22 May 2024 23:32">Wednesday 22 May 2024</span>. Using Julia version 1.10.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
