<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Integration Guide · CompetingClocks.jl Documentation</title><meta name="title" content="Integration Guide · CompetingClocks.jl Documentation"/><meta property="og:title" content="Integration Guide · CompetingClocks.jl Documentation"/><meta property="twitter:title" content="Integration Guide · CompetingClocks.jl Documentation"/><meta name="description" content="Documentation for CompetingClocks.jl Documentation."/><meta property="og:description" content="Documentation for CompetingClocks.jl Documentation."/><meta property="twitter:description" content="Documentation for CompetingClocks.jl Documentation."/><meta property="og:url" content="https://adolgert.github.io/CompetingClocks.jl/integration-guide/"/><meta property="twitter:url" content="https://adolgert.github.io/CompetingClocks.jl/integration-guide/"/><link rel="canonical" href="https://adolgert.github.io/CompetingClocks.jl/integration-guide/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">CompetingClocks.jl Documentation</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../install/">Installation</a></li><li><a class="tocitem" href="../quickstart/">Quickstart</a></li><li><a class="tocitem" href="../mainloop/">Sample Main Loop</a></li><li><a class="tocitem" href="../choosing_sampler/">Choosing a Sampler</a></li></ul></li><li><span class="tocitem">User Guide</span><ul><li class="is-active"><a class="tocitem" href>Integration Guide</a><ul class="internal"><li><a class="tocitem" href="#Core-Integration-Pattern"><span>Core Integration Pattern</span></a></li><li><a class="tocitem" href="#Design-Decisions"><span>Design Decisions</span></a></li><li><a class="tocitem" href="#Common-Integration-Patterns"><span>Common Integration Patterns</span></a></li><li><a class="tocitem" href="#Spatial-Simulation"><span>Spatial Simulation</span></a></li><li><a class="tocitem" href="#Advanced-Features"><span>Advanced Features</span></a></li><li><a class="tocitem" href="#Variance-reduction"><span>Variance reduction</span></a></li><li><a class="tocitem" href="#Error-Handling-and-Debugging"><span>Error Handling and Debugging</span></a></li><li><a class="tocitem" href="#Performance-Considerations"><span>Performance Considerations</span></a></li></ul></li><li><a class="tocitem" href="../low_level_interface/">Low-level Sampler Interface</a></li><li><a class="tocitem" href="../samplers/">Understanding Samplers</a></li><li><a class="tocitem" href="../delayed/">Delayed Clocks</a></li><li><a class="tocitem" href="../guide/">Competing Clocks</a></li><li><a class="tocitem" href="../distributions/">Non-exponential Simulation</a></li><li><a class="tocitem" href="../hierarchical/">Hierarchical Samplers</a></li><li><a class="tocitem" href="../debugging/">Debugging a Simulation that Uses CompetingClocks</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../reliability/">Reliability</a></li><li><a class="tocitem" href="../sir/">SIR Model</a></li><li><a class="tocitem" href="../constant_birth/">Birth-death Process</a></li><li><a class="tocitem" href="../memory/">Transitions with Memory</a></li><li><a class="tocitem" href="../gene_expression/">Gene Expression</a></li></ul></li><li><span class="tocitem">Statistical Methods</span><ul><li><a class="tocitem" href="../commonrandom/">Common Random Numbers</a></li><li><a class="tocitem" href="../importance_skills/">Importance Sampling for Simulation</a></li><li><a class="tocitem" href="../hamiltonianmontecarlo/">Hamiltonian Monte Carlo</a></li><li><input class="collapse-toggle" id="menuitem-5-4" type="checkbox"/><label class="tocitem" for="menuitem-5-4"><span class="docs-label">Gen.jl Integration</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../gen/overview/">Gen.jl and CompetingClocks.jl</a></li><li><a class="tocitem" href="../gen/distribution/">CompetingClocks as a Gen Distribution</a></li><li><a class="tocitem" href="../gen/generative_function/">CompetingClocks as a Gen Generative Function</a></li><li><a class="tocitem" href="../gen/observation_likelihood/">Observation Likelihood for Event Data</a></li><li><a class="tocitem" href="../gen/importance_mixture/">Importance Sampling with Mixture Proposals</a></li><li><a class="tocitem" href="../gen/hmc_paths/">HMC over Event Paths with Gen.jl</a></li></ul></li><li><a class="tocitem" href="../gen/turing_dist/">Bayesian Inference with Turing.jl</a></li><li><a class="tocitem" href="../gen/survival_snippet/">Integration with Survival.jl</a></li></ul></li><li><span class="tocitem">API Reference</span><ul><li><a class="tocitem" href="../contextinterface/">Context Interface</a></li><li><a class="tocitem" href="../reference/">Samplers</a></li><li><a class="tocitem" href="../algorithms/">Algorithms</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">User Guide</a></li><li class="is-active"><a href>Integration Guide</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Integration Guide</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/adolgert/CompetingClocks.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/adolgert/CompetingClocks.jl/blob/main/docs/src/integration-guide.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Integration-Guide"><a class="docs-heading-anchor" href="#Integration-Guide">Integration Guide</a><a id="Integration-Guide-1"></a><a class="docs-heading-anchor-permalink" href="#Integration-Guide" title="Permalink"></a></h1><p>How your code can use CompetingClocks.jl as a sampling engine.</p><h2 id="Core-Integration-Pattern"><a class="docs-heading-anchor" href="#Core-Integration-Pattern">Core Integration Pattern</a><a id="Core-Integration-Pattern-1"></a><a class="docs-heading-anchor-permalink" href="#Core-Integration-Pattern" title="Permalink"></a></h2><p>CompetingClocks manages <em>when</em> events happen. Your framework manages <em>what</em> happens.</p><p>Your framework provides:</p><ul><li>State representation</li><li>Event-handling logic</li><li>A user-facing API</li></ul><p>CompetingClocks provides:</p><ul><li>Event timing and scheduling</li><li>Distribution sampling</li><li>Variance reduction and likelihood calculation</li></ul><p>A minimal integration loop:</p><pre><code class="language-julia hljs">function run_simulation(model, sampler, rng, end_time)
    initialize_events!(model, sampler)  # Your code

    when, which = next(sampler)
    while !isnothing(which) &amp;&amp; when &lt; end_time
        fire!(sampler, which, when)
        handle_event!(model, sampler, which, when, rng)  # Your code
        when, which = next(sampler)
    end
end</code></pre><h2 id="Design-Decisions"><a class="docs-heading-anchor" href="#Design-Decisions">Design Decisions</a><a id="Design-Decisions-1"></a><a class="docs-heading-anchor-permalink" href="#Design-Decisions" title="Permalink"></a></h2><h3 id="Clock-Key-Type"><a class="docs-heading-anchor" href="#Clock-Key-Type">Clock Key Type</a><a id="Clock-Key-Type-1"></a><a class="docs-heading-anchor-permalink" href="#Clock-Key-Type" title="Permalink"></a></h3><p>How will you identify events? CompetingClocks.jl indexes events using an immutable clock key that you provide. Examples:</p><ul><li><code>(:infect, infectious, susceptible)</code> - <code>Tuple{Symbol,Int,Int}</code> or <code>Tuple</code></li><li><code>392</code> - <code>Int64</code></li><li><code>:i =&gt; 37</code> - A Pair for use with <code>Gen.jl</code>.</li></ul><p>A custom struct type for events works well. Using a concrete type is more performant for sampling.</p><h3 id="Threading"><a class="docs-heading-anchor" href="#Threading">Threading</a><a id="Threading-1"></a><a class="docs-heading-anchor-permalink" href="#Threading" title="Permalink"></a></h3><p>This package doesn&#39;t use Tasks or thread guards because it is so common to run multiple copies of a simulation, each on its own thread. If you run multiple simulations, it can be more correct to use random number generators that work in parallel, such as those in the <code>Random123</code> package or the <code>jump!()</code> method for the <code>Xoshiro</code> sampler in the <code>Random</code> package.</p><h3 id="State-and-Dependencies"><a class="docs-heading-anchor" href="#State-and-Dependencies">State and Dependencies</a><a id="State-and-Dependencies-1"></a><a class="docs-heading-anchor-permalink" href="#State-and-Dependencies" title="Permalink"></a></h3><p>Your simulation handles all state. <code>CompetingClocks</code> only knows about enabled events. It can be very helpful for performance if you use information about relationships among events to limit updates to the samplers. There are a few kinds of dependency graphs that may help.</p><ul><li>Dependency Graph–-When one event fires, it changes state. Which other events could be enabled or disabled because of the changed state?</li><li>Rate Dependency Graph–-When one event fires, it changes state. Which other events have transition <em>rates</em> that depend on that state? The event may remain enabled, but its distribution of firing times may have a different parameter value.</li><li>Event-to-event Graph–-When one event fires, you might know directly which other events have enabling rules or transition rates that depend on that first event, without needing to ask what state changed and what events depend on the state.</li></ul><p>How you represent a dependency graph depends on the problem.</p><h2 id="Common-Integration-Patterns"><a class="docs-heading-anchor" href="#Common-Integration-Patterns">Common Integration Patterns</a><a id="Common-Integration-Patterns-1"></a><a class="docs-heading-anchor-permalink" href="#Common-Integration-Patterns" title="Permalink"></a></h2><h3 id="Agent-based-Models"><a class="docs-heading-anchor" href="#Agent-based-Models">Agent-based Models</a><a id="Agent-based-Models-1"></a><a class="docs-heading-anchor-permalink" href="#Agent-based-Models" title="Permalink"></a></h3><p>The clock key will identify an action and an agent, along with either another agent or a location.</p><pre><code class="language-julia hljs">struct ClockKey
    action::Symbol
    who::Int
    other::Int # other agent or location
end</code></pre><p>It&#39;s also easy to use a <code>Tuple</code> as a ClockKey until you figure out the space of all possible keys.</p><h2 id="Spatial-Simulation"><a class="docs-heading-anchor" href="#Spatial-Simulation">Spatial Simulation</a><a id="Spatial-Simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Spatial-Simulation" title="Permalink"></a></h2><p>Split the sampler into groups so that each region is faster.</p><pre><code class="language-julia hljs">builder = SamplerBuilder(EventKey, Float64)
for region in spatial_grid
    add_group!(builder, region.name =&gt; (key, dist) -&gt; key.location == region.id)
end</code></pre><h3 id="Chemical-Reaction-Networks"><a class="docs-heading-anchor" href="#Chemical-Reaction-Networks">Chemical Reaction Networks</a><a id="Chemical-Reaction-Networks-1"></a><a class="docs-heading-anchor-permalink" href="#Chemical-Reaction-Networks" title="Permalink"></a></h3><p>Map reactions to events.</p><pre><code class="language-julia hljs">function enable_reaction!(sampler, reaction, state, params)
    propensity = calculate_propensity(reaction, state, params)
    enable!(sampler, reaction.id, Exponential(1/propensity))
end</code></pre><h2 id="Advanced-Features"><a class="docs-heading-anchor" href="#Advanced-Features">Advanced Features</a><a id="Advanced-Features-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-Features" title="Permalink"></a></h2><p>There is extra work in a simulation to support some of the sampler features.</p><h3 id="Exposing-likelihood-calculation"><a class="docs-heading-anchor" href="#Exposing-likelihood-calculation">Exposing likelihood calculation</a><a id="Exposing-likelihood-calculation-1"></a><a class="docs-heading-anchor-permalink" href="#Exposing-likelihood-calculation" title="Permalink"></a></h3><p>The step log-likelihood and path log-likelihood can be found from the sampler at any point during a simulation. They are always calulated relative to the last event to <code>fire!()</code>, even if <code>next()</code> has been called.</p><pre><code class="language-julia hljs">builder = SamplerBuilder(KeyType, Float64;
    path_likelihood=true)
sampler = SamplingContext(builder, rng)
# After simulation, the log_prob is a Float64.
log_prob = pathloglikelihood(sampler, end_time)</code></pre><p>The resulting value is the likelihood of a single trajectory of the system. The <code>pathloglikelihood</code> is a regular function and can be differentiated.</p><h2 id="Variance-reduction"><a class="docs-heading-anchor" href="#Variance-reduction">Variance reduction</a><a id="Variance-reduction-1"></a><a class="docs-heading-anchor-permalink" href="#Variance-reduction" title="Permalink"></a></h2><p>Construct the sampler with the <code>common_random</code> option.</p><pre><code class="language-julia hljs">builder = SamplerBuilder(KeyType, Float64; common_random=true)
sampler = SamplingContext(builder, rng)</code></pre><p>Run the simulation a bunch of times, calling <code>reset!()</code> between runs to clear the sampler&#39;s memory of the previous run but save the common random numbers. Each run will pin more random draws. Then use <code>freeze_crn!</code> to stop collecting random draws.</p><pre><code class="language-julia hljs">for i in 1:warm_up
    reset!(sampler)
    results1 = run_simulation(model, sampler)
end
freeze_crn!(sampler)  # Lock random draws</code></pre><p>Replay with different parameters.</p><pre><code class="language-julia hljs">for i in 1:draw_cnt
    reset!(sampler) # Do this before each run with same sampler.
    results2 = run_simulation(model, sampler)  # Uses same random draws
end</code></pre><p>Each simulation copy also needs a copy of the state.</p><p>If you want to run these multithreaded, you can use <code>clone()</code> to copy the sampler to a vector and then use <code>copy_clocks!</code> to initialize all the samplers in the vector with the common random numbers that were just collected.</p><pre><code class="language-julia hljs">master_seed = (0x3a97a224, 0x65ff9227)
common_samplers = Vector{typeof(sampler)}(undef, clone_cnt)
for i in 1:clone_cnt
    rng = Philox4x((0, 0, 0, init_idx), master_seed)
    common_samplers[init_idx] = clone(sampler, rng)
end
# Run warm-up of common random numbers here, and freeze them.
for i in 1:clone_cnt
    copy_clocks!(common_samplers[i], sampler)
end</code></pre><p>Then run tasks on the clones of the frozen sampler.</p><h3 id="Path-splitting-for-rare-events"><a class="docs-heading-anchor" href="#Path-splitting-for-rare-events">Path splitting for rare events</a><a id="Path-splitting-for-rare-events-1"></a><a class="docs-heading-anchor-permalink" href="#Path-splitting-for-rare-events" title="Permalink"></a></h3><p>This is a simple form of importance sampling. When a simulation gets near a space of interesting results, take the current trajectory and make multiple copies of the simulation, both the state and the samplers. Weight the results of each copy by one over the number of copies.</p><p>CompetingClocks offers a <code>split!</code> function that copies the state to a vector of clocks and keeps a <code>split_weight</code> as a record of how many times splitting was done. Take a look at the implementation of <a href="../reference/#CompetingClocks.split!"><code>CompetingClocks.split!()</code></a>.</p><p>Your code might keep the sampler in the main simulation framework, in which case you would include the sampler in the cloning and copying process.</p><h2 id="Error-Handling-and-Debugging"><a class="docs-heading-anchor" href="#Error-Handling-and-Debugging">Error Handling and Debugging</a><a id="Error-Handling-and-Debugging-1"></a><a class="docs-heading-anchor-permalink" href="#Error-Handling-and-Debugging" title="Permalink"></a></h2><p>If you call the sampler builder with <code>debug=true</code> then there will be logging.</p><pre><code class="language-julia hljs">builder = SamplerBuilder(KeyType, Float64; debug=true)
sampler = SamplingContext(builder, rng)</code></pre><p>Then run with logging on.</p><pre><code class="language-julia hljs">with_logger(ConsoleLogger(stdout, Logging.Debug)) do
    observed, importance = run_epochs(100)
end</code></pre><p>There is also a <a href="https://en.wikipedia.org/wiki/Chaos_engineering">chaos-monkey</a> option called a <code>Petri</code> sampler. This sampler always advances time by the same time step <code>dt=1.0</code> by default, and it ignores the clock distributions. It chooses any enabled sampler at each step, with the goal of finding unusual sampling paths. This is surprisingly effective at finding logic errors in code to change state.</p><h2 id="Performance-Considerations"><a class="docs-heading-anchor" href="#Performance-Considerations">Performance Considerations</a><a id="Performance-Considerations-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-Considerations" title="Permalink"></a></h2><p><strong>Type Stability</strong>–-Use a concrete type for the ClockKey for more speed.</p><p><strong>Sampler Choice</strong>–-If there are a lot of clocks enabled at the same time, the the sampler choice can be important. Experts in traffic simulation use hierarchical samplers to split sampling by geographic location but also split fast events from slow events. There are also fine-grained choices for samplers about whether clock keys are reused.</p><p><strong>Memory Allocation</strong>–-Instead of making a new sampler for each run, use <code>reset!(sampler)</code> between runs to clear out the clocks.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../choosing_sampler/">« Choosing a Sampler</a><a class="docs-footer-nextpage" href="../low_level_interface/">Low-level Sampler Interface »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Friday 28 November 2025 20:25">Friday 28 November 2025</span>. Using Julia version 1.12.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
